name: Destroy

on:
    workflow_dispatch: {}

env:
    AWS_REGION: us-east-1
    PROJECT_NAME: cafe

jobs:
    destroy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-session-token:     ${{ secrets.AWS_SESSION_TOKEN }}
                  aws-region:            ${{ secrets.AWS_REGION }}
                
            - name: Compute backend names
              id: acct
              run: |
                ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
                echo "BUCKET=${{ env.PROJECT_NAME }}-tfstate-${ACCOUNT_ID}" >> $GITHUB_OUTPUT
                echo "LOCK_TABLE=${{ env.PROJECT_NAME }}-tf-lock" >> $GITHUB_OUTPUT
            
            - name: Write backend config
              run: |
                mkdir -p infra
                cat > infra/backend.tf <<EOF
                bucket = "${{ steps.acct.outputs.BUCKET }}"
                key    = "infra/terraform.tfstate"
                region = "${{ env.AWS_REGION }}"
                dynamodb_table = "${{ steps.acct.outputs.LOCK_TABLE }}"
                encrpyt = true
                EOF
            
            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.6.6
            
            - name: Terraform Init
              working-directory: infra
              run: terraform init -input=false -backend-config=backend.hcl

            - name: Terraform Destroy
              working-directory: infra
              run: terraform destroy -auto-approve -var-file=env/dev.tfvars