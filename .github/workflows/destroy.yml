name: Destroy

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type DELETE to confirm"
        required: true
        default: ""
      region:
        description: "AWS region to target"
        required: true
        default: "eu-north-1"

env:
  PROJECT_NAME: cafe

jobs:
  destroy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Safety check (confirmation)
        run: |
          if [ "${{ inputs.confirm }}" != "DELETE" ]; then
            echo "You must type DELETE to proceed."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ inputs.region }}

      - name: Who am I (AWS STS)
        run: |
          aws sts get-caller-identity
          aws configure get region

      - name: Compute backend names
        id: acct
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "ACCOUNT_ID=${ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "BUCKET=${{ env.PROJECT_NAME }}-tfstate-${ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "LOCK_TABLE=${{ env.PROJECT_NAME }}-tf-lock" >> $GITHUB_OUTPUT

      - name: Write backend config (runtime only)
        run: |
          mkdir -p infra
          cat > infra/backend.hcl <<EOF
          bucket         = "${{ steps.acct.outputs.BUCKET }}"
          key            = "infra/terraform.tfstate"
          region         = "${{ inputs.region }}"
          dynamodb_table = "${{ steps.acct.outputs.LOCK_TABLE }}"
          encrypt        = true
          EOF

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Clean local Terraform artifacts
        working-directory: infra
        run: |
          rm -rf .terraform terraform.tfstate terraform.tfstate.backup .terraform.lock.hcl
          ls -la

      - name: Terraform init
        working-directory: infra
        run: terraform init -input=false -backend-config=backend.hcl -reconfigure

      - name: Terraform destroy (from state)
        working-directory: infra
        run: |
          set +e
          terraform destroy -auto-approve -var-file=env/dev.tfvars
          exit 0

      # ============================================================
      # BEST-EFFORT PURGE: Anything containing "cafe" in this region
      # ============================================================
      - name: Purge cafe* resources (best effort)
        shell: bash
        run: |
          set +e
          REGION="${{ inputs.region }}"
          TERM="${{ env.PROJECT_NAME }}"  # "cafe"

          echo "=== PURGE START: region=$REGION term=$TERM ==="

          # -------- CloudWatch Log Groups --------
          echo "Deleting CloudWatch log groups containing '$TERM'..."
          for lg in $(aws logs describe-log-groups --region "$REGION" \
            --query "logGroups[?contains(logGroupName, \`${TERM}\`)].logGroupName" \
            --output text 2>/dev/null); do
            echo "  - delete log group: $lg"
            aws logs delete-log-group --region "$REGION" --log-group-name "$lg" >/dev/null 2>&1 || true
          done

          # -------- ECR Repos --------
          echo "Deleting ECR repositories containing '$TERM'..."
          for repo in $(aws ecr describe-repositories --region "$REGION" \
            --query "repositories[?contains(repositoryName, \`${TERM}\`)].repositoryName" \
            --output text 2>/dev/null); do
            echo "  - delete ecr repo: $repo"
            aws ecr delete-repository --region "$REGION" --repository-name "$repo" --force >/dev/null 2>&1 || true
          done

          # -------- ALB + Listeners + Target Groups --------
          echo "Deleting ALBs containing '$TERM'..."
          LBS=$(aws elbv2 describe-load-balancers --region "$REGION" \
            --query "LoadBalancers[?contains(LoadBalancerName, \`${TERM}\`)].LoadBalancerArn" \
            --output text 2>/dev/null)
          for lb in $LBS; do
            echo "  - delete listeners for lb: $lb"
            for lis in $(aws elbv2 describe-listeners --region "$REGION" --load-balancer-arn "$lb" \
              --query "Listeners[].ListenerArn" --output text 2>/dev/null); do
              aws elbv2 delete-listener --region "$REGION" --listener-arn "$lis" >/dev/null 2>&1 || true
            done
            echo "  - delete lb: $lb"
            aws elbv2 delete-load-balancer --region "$REGION" --load-balancer-arn "$lb" >/dev/null 2>&1 || true
          done

          echo "Deleting target groups containing '$TERM'..."
          for tg in $(aws elbv2 describe-target-groups --region "$REGION" \
            --query "TargetGroups[?contains(TargetGroupName, \`${TERM}\`)].TargetGroupArn" \
            --output text 2>/dev/null); do
            echo "  - delete tg: $tg"
            aws elbv2 delete-target-group --region "$REGION" --target-group-arn "$tg" >/dev/null 2>&1 || true
          done

          # -------- Auto Scaling Groups --------
          echo "Deleting Auto Scaling Groups containing '$TERM'..."
          ASGS=$(aws autoscaling describe-auto-scaling-groups --region "$REGION" \
            --query "AutoScalingGroups[?contains(AutoScalingGroupName, \`${TERM}\`)].AutoScalingGroupName" \
            --output text 2>/dev/null)
          for asg in $ASGS; do
            echo "  - set desired=0 and delete asg: $asg"
            aws autoscaling update-auto-scaling-group --region "$REGION" --auto-scaling-group-name "$asg" \
              --min-size 0 --max-size 0 --desired-capacity 0 >/dev/null 2>&1 || true
            aws autoscaling delete-auto-scaling-group --region "$REGION" --auto-scaling-group-name "$asg" --force-delete >/dev/null 2>&1 || true
          done

          # -------- Launch Templates --------
          echo "Deleting Launch Templates containing '$TERM'..."
          for lt_id in $(aws ec2 describe-launch-templates --region "$REGION" \
            --query "LaunchTemplates[?contains(LaunchTemplateName, \`${TERM}\`)].LaunchTemplateId" \
            --output text 2>/dev/null); do
            echo "  - delete launch template: $lt_id"
            aws ec2 delete-launch-template --region "$REGION" --launch-template-id "$lt_id" >/dev/null 2>&1 || true
          done

          # -------- EC2 Instances (Name tag contains cafe) --------
          echo "Terminating EC2 instances with Name containing '$TERM'..."
          INSTANCES=$(aws ec2 describe-instances --region "$REGION" \
            --filters "Name=tag:Name,Values=*${TERM}*" "Name=instance-state-name,Values=pending,running,stopping,stopped" \
            --query "Reservations[].Instances[].InstanceId" \
            --output text 2>/dev/null)
          if [ -n "$INSTANCES" ]; then
            echo "  - terminate: $INSTANCES"
            aws ec2 terminate-instances --region "$REGION" --instance-ids $INSTANCES >/dev/null 2>&1 || true
          fi

          # -------- VPC delete helper (targets VPCs whose Name tag contains cafe) --------
          delete_vpc() {
            local vpc="$1"
            echo "---- Attempting to delete VPC $vpc ----"

            # NAT gateways
            for nat in $(aws ec2 describe-nat-gateways --region "$REGION" --filter "Name=vpc-id,Values=$vpc" \
              --query "NatGateways[].NatGatewayId" --output text 2>/dev/null); do
              echo "  - delete nat: $nat"
              aws ec2 delete-nat-gateway --region "$REGION" --nat-gateway-id "$nat" >/dev/null 2>&1 || true
            done

            # Internet gateways
            for igw in $(aws ec2 describe-internet-gateways --region "$REGION" --filters "Name=attachment.vpc-id,Values=$vpc" \
              --query "InternetGateways[].InternetGatewayId" --output text 2>/dev/null); do
              echo "  - detach+delete igw: $igw"
              aws ec2 detach-internet-gateway --region "$REGION" --internet-gateway-id "$igw" --vpc-id "$vpc" >/dev/null 2>&1 || true
              aws ec2 delete-internet-gateway --region "$REGION" --internet-gateway-id "$igw" >/dev/null 2>&1 || true
            done

            # VPC endpoints
            for ep in $(aws ec2 describe-vpc-endpoints --region "$REGION" --filters "Name=vpc-id,Values=$vpc" \
              --query "VpcEndpoints[].VpcEndpointId" --output text 2>/dev/null); do
              echo "  - delete vpce: $ep"
              aws ec2 delete-vpc-endpoints --region "$REGION" --vpc-endpoint-ids "$ep" >/dev/null 2>&1 || true
            done

            # Security groups (non-default)
            for sg in $(aws ec2 describe-security-groups --region "$REGION" --filters "Name=vpc-id,Values=$vpc" \
              --query "SecurityGroups[?GroupName!='default'].GroupId" --output text 2>/dev/null); do
              echo "  - delete sg: $sg"
              aws ec2 delete-security-group --region "$REGION" --group-id "$sg" >/dev/null 2>&1 || true
            done

            # Subnets
            for subnet in $(aws ec2 describe-subnets --region "$REGION" --filters "Name=vpc-id,Values=$vpc" \
              --query "Subnets[].SubnetId" --output text 2>/dev/null); do
              echo "  - delete subnet: $subnet"
              aws ec2 delete-subnet --region "$REGION" --subnet-id "$subnet" >/dev/null 2>&1 || true
            done

            # Non-main route tables
            for rtb in $(aws ec2 describe-route-tables --region "$REGION" --filters "Name=vpc-id,Values=$vpc" \
              --query "RouteTables[?Associations[?Main==\`false\`]].RouteTableId" --output text 2>/dev/null); do
              echo "  - delete rtb: $rtb"
              aws ec2 delete-route-table --region "$REGION" --route-table-id "$rtb" >/dev/null 2>&1 || true
            done

            echo "  - delete vpc: $vpc"
            aws ec2 delete-vpc --region "$REGION" --vpc-id "$vpc" >/dev/null 2>&1 || true
          }

          echo "Deleting VPCs with Name tag containing '$TERM' (excluding default VPC automatically)..."
          VPCS=$(aws ec2 describe-vpcs --region "$REGION" \
            --filters "Name=isDefault,Values=false" \
            --query "Vpcs[?Tags && length(Tags[?Key==\`Name\` && contains(Value, \`${TERM}\`)])> \`0\`].VpcId" \
            --output text 2>/dev/null)
          for vpc in $VPCS; do
            delete_vpc "$vpc"
          done

          echo "=== PURGE FINISHED (best effort). ==="
